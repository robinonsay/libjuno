/*
    MIT License

    Copyright (c) 2025 Robin A. Onsay

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files
    (the "Software"), to deal in the Software without restriction,
    including without limitation the rights to use, copy, modify, merge,
    publish, distribute, sublicense, and/or sell copies of the Software,
    and to permit persons to whom the Software is furnished to do so,
    subject to the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.
*/

/**
    This API has been generated by LibJuno:
    https://www.robinonsay.com/libjuno/
*/

/**
 * @file pointer_api.h
 * @brief Pointer trait and helpers for memory operations.
 * @defgroup juno_memory_pointer Pointer API
 * @details
 *  Defines a portable pointer trait (JUNO_POINTER_T) with an associated API
 *  for copying and resetting memory, along with helpers to verify type and
 *  alignment. A separate value-pointer API allows equality checks over
 *  pointer contents. These utilities are used by allocators and callers to
 *  enforce size/alignment constraints and perform safe operations in a
 *  freestanding-friendly way.
 */
#ifndef JUNO_POINTER_API_H
#define JUNO_POINTER_API_H
#include "juno/macros.h"
#include "juno/status.h"
#include "juno/module.h"
#include <stddef.h>
#include <stdalign.h>
#include <stdint.h> // for uintptr_t used in type/alignment verification macros
#include "juno/types.h"
#ifdef __cplusplus
extern "C"
{
#endif

typedef struct JUNO_POINTER_TAG JUNO_POINTER_T;
typedef struct JUNO_POINTER_API_TAG JUNO_POINTER_API_T;
typedef struct JUNO_VALUE_POINTER_API_TAG JUNO_VALUE_POINTER_API_T;


/// @brief Structure describing an address, its size and alignment.
struct JUNO_POINTER_TAG JUNO_TRAIT_ROOT(JUNO_POINTER_API_T,
    /// Address of the memory region.
    void *pvAddr;
    /// Size of the memory region in bytes.
    size_t zSize;
    /// Minimum required alignment in bytes.
    size_t zAlignment;
);

/**
 * @brief Pointer operations API (copy/reset).
 * @ingroup juno_memory_pointer
 * @details Implementations should enforce type-appropriate semantics:
 *  - Copy: copies the value referenced by tSrc into tDest's storage location
 *    (size/alignment validated by callers via verification helpers/macros).
 *  - Reset: resets the pointee to a defined "empty" state (often zero-init),
 *    suitable for clearing slots in containers.
 */
struct JUNO_POINTER_API_TAG
{
    /// @brief Copy memory from source to destination.
    /// @param tDest Destination pointer descriptor.
    /// @param tSrc Source pointer descriptor.
    /// @return JUNO_STATUS_SUCCESS on success, error code otherwise.
    JUNO_STATUS_T (*Copy)(JUNO_POINTER_T tDest, const JUNO_POINTER_T tSrc);
    /// @brief Reset the memory at the pointer (e.g., zero-initialize).
    /// @param tPointer Pointer descriptor to reset.
    /// @return JUNO_STATUS_SUCCESS on success, error code otherwise.
    JUNO_STATUS_T (*Reset)(JUNO_POINTER_T tPointer);
};


/**
 * @brief Value-pointer operations API (equality by contents).
 * @ingroup juno_memory_pointer
 * @details Equals should compare logical key/value identity based on pointee
 *  contents, not pointer identity. Used by associative containers (e.g., map).
 */
struct JUNO_VALUE_POINTER_API_TAG
{
    /// @brief Compare two pointer values for equality (by contents).
    /// @return Result with tStatus and boolean equality in tOk.
    JUNO_RESULT_BOOL_T (*Equals)(const JUNO_POINTER_T tLeft, const JUNO_POINTER_T tRight);
};

/** @brief Result type carrying a pointer descriptor.
 *  @ingroup juno_memory_pointer
 */
JUNO_MODULE_RESULT(JUNO_RESULT_POINTER_T, JUNO_POINTER_T);
/** @brief Option type carrying a pointer descriptor.
 *  @ingroup juno_memory_pointer
 */
JUNO_MODULE_OPTION(JUNO_OPTION_POINTER_T, JUNO_POINTER_T);

/**
 * @def JunoMemory_PointerInit(ptApi, TYPE_T, pvAddr)
 * @brief Initialize a JUNO_POINTER_T with API, type, and address.
 * @ingroup juno_memory_pointer
 * @param ptApi Pointer to a valid JUNO_POINTER_API_T.
 * @param TYPE_T The value type at pvAddr (deduces size and alignment).
 * @param pvAddr Address of the value or buffer.
 * @return A populated JUNO_POINTER_T describing the location, size, and alignment.
 */
#define JunoMemory_PointerInit(ptApi, TYPE_T, pvAddr) (JUNO_POINTER_T){ptApi, pvAddr, sizeof(TYPE_T), alignof(TYPE_T)}
/**
 * @def JunoMemory_PointerVerifyType(pointer, type, tApi)
 * @brief Verify pointer descriptor matches an expected type and API.
 * @ingroup juno_memory_pointer
 * @param pointer The JUNO_POINTER_T descriptor to verify.
 * @param type The expected C type for the memory region.
 * @param tApi The expected JUNO_POINTER_API_T symbol.
 * @return JUNO_STATUS_SUCCESS if the descriptor is valid and matches, error otherwise.
 */
#define JunoMemory_PointerVerifyType(pointer, type, tApi) \
(( \
    JunoMemory_PointerVerify(pointer) == JUNO_STATUS_SUCCESS && \
    pointer.ptApi == &tApi && \
    pointer.zSize == sizeof(type) && \
    pointer.zAlignment == alignof(type) && \
    (uintptr_t) pointer.pvAddr % pointer.zAlignment == 0 \
)?JUNO_STATUS_SUCCESS:JUNO_STATUS_ERR)

/**
 * @def JUNO_ASSERT_POINTER_TYPE(tStatus, tPointer, tType, tApi)
 * @brief Assert a pointer descriptor's type and API, returning on failure.
 * @ingroup juno_memory_pointer
 * @param tStatus Lvalue to receive the resulting status.
 * @param tPointer The pointer descriptor to validate.
 * @param tType The expected type of the pointee.
 * @param tApi The expected pointer API symbol.
 */
#define JUNO_ASSERT_POINTER_TYPE(tStatus, tPointer, tType, tApi)  JUNO_ASSERT_SUCCESS((tStatus = JunoMemory_PointerVerifyType(tPointer, tType, tApi)), return tStatus)

/**
 * @brief Verify that a pointer API provides required functions.
 * @ingroup juno_memory_pointer
 * @param ptPointerApi Pointer to the API vtable.
 * @return JUNO_STATUS_SUCCESS if all required functions are present.
 */
static inline JUNO_STATUS_T JunoMemory_PointerApiVerify(const JUNO_POINTER_API_T *ptPointerApi)
{
    JUNO_ASSERT_EXISTS(
        ptPointerApi &&
        ptPointerApi->Copy &&
        ptPointerApi->Reset
    );
    return JUNO_STATUS_SUCCESS;
}

/**
 * @brief Verify that a value-pointer API provides required functions.
 * @ingroup juno_memory_pointer
 * @param ptPointerApi Pointer to the value-pointer API vtable.
 * @return JUNO_STATUS_SUCCESS if all required functions are present.
 */
static inline JUNO_STATUS_T JunoMemory_ValuePointerApiVerify(const JUNO_VALUE_POINTER_API_T *ptPointerApi)
{
    JUNO_ASSERT_EXISTS(
        ptPointerApi &&
        ptPointerApi->Equals
    );
    return JUNO_STATUS_SUCCESS;
}

/**
 * @brief Verify a pointer descriptor (API non-null, address non-null, size non-zero).
 * @ingroup juno_memory_pointer
 * @param tPointer The pointer descriptor to check.
 * @return JUNO_STATUS_SUCCESS if valid; error otherwise.
 */
static inline JUNO_STATUS_T JunoMemory_PointerVerify(const JUNO_POINTER_T tPointer)
{
    JUNO_ASSERT_EXISTS(
        tPointer.ptApi &&
        tPointer.pvAddr &&
        tPointer.zSize
    );
    JUNO_STATUS_T tStatus = JunoMemory_PointerApiVerify(tPointer.ptApi);
    JUNO_ASSERT_SUCCESS(tStatus, return tStatus);
    return tStatus;
}

#ifdef __cplusplus
}
#endif
#endif // JUNO_POINTER_API_H

